bundle:
  name: rag-ingestion

include:
  - ./config/*.yml

workspace:
  root_path: /Workspace/Users/${workspace.current_user.userName}/.bundle/${bundle.name}/${bundle.target}

resources:
  jobs:
    document_ingestion_job:
      name: "[${bundle.target}] RAG Document Ingestion"
      parameters:
        - name: document_names
          default: ""
      environments:
        - environment_key: ingestion_env
          spec:
            environment_version: "2"
            dependencies:
              - azure-ai-formrecognizer>=3.3.0
              - azure-storage-blob>=12.19.0
              - tiktoken>=0.7.0
              - azure-ai-inference>=1.0.0b6
              - azure-search-documents>=11.4.0
      tasks:
        - task_key: parse_documents
          environment_key: ingestion_env
          notebook_task:
            notebook_path: ./notebooks/01_document_parsing.py
            base_parameters:
              document_names: "{{job.parameters.document_names}}"
            source: WORKSPACE
          timeout_seconds: 3600

        - task_key: chunk_documents
          depends_on:
            - task_key: parse_documents
          environment_key: ingestion_env
          notebook_task:
            notebook_path: ./notebooks/02_chunking.py
            source: WORKSPACE
          timeout_seconds: 1800

        - task_key: generate_embeddings
          depends_on:
            - task_key: chunk_documents
          environment_key: ingestion_env
          notebook_task:
            notebook_path: ./notebooks/03_embedding_generation.py
            source: WORKSPACE
          timeout_seconds: 7200

        - task_key: index_documents
          depends_on:
            - task_key: generate_embeddings
          environment_key: ingestion_env
          notebook_task:
            notebook_path: ./notebooks/04_indexing.py
            source: WORKSPACE
          timeout_seconds: 3600

targets:
  dev:
    mode: development
    default: true
  staging:
    mode: development
  prod:
    mode: production
