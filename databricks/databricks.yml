bundle:
  name: rag-ingestion

include:
  - ./config/*.yml

workspace:
  root_path: /Workspace/Users/${workspace.current_user.userName}/.bundle/${bundle.name}/${bundle.target}

resources:
  jobs:
    document_ingestion_job:
      name: "[${bundle.target}] RAG Document Ingestion"
      schedule:
        quartz_cron_expression: "0 0 2 * * ?"
        timezone_id: UTC
        pause_status: PAUSED
      environments:
        - environment_key: ingestion_env
          spec:
            environment_version: "2"
            dependencies:
              - azure-ai-formrecognizer>=3.3.0
              - azure-storage-blob>=12.19.0
              - tiktoken>=0.7.0
              - azure-ai-inference>=1.0.0b6
              - azure-search-documents>=11.4.0
      tasks:
        - task_key: parse_documents
          environment_key: ingestion_env
          notebook_task:
            notebook_path: ./notebooks/01_document_parsing.py
            source: WORKSPACE
          timeout_seconds: 3600

        - task_key: chunk_documents
          depends_on:
            - task_key: parse_documents
          environment_key: ingestion_env
          notebook_task:
            notebook_path: ./notebooks/02_chunking.py
            source: WORKSPACE
          timeout_seconds: 1800

        - task_key: generate_embeddings
          depends_on:
            - task_key: chunk_documents
          environment_key: ingestion_env
          notebook_task:
            notebook_path: ./notebooks/03_embedding_generation.py
            source: WORKSPACE
          timeout_seconds: 7200

        - task_key: index_documents
          depends_on:
            - task_key: generate_embeddings
          environment_key: ingestion_env
          notebook_task:
            notebook_path: ./notebooks/04_indexing.py
            source: WORKSPACE
          timeout_seconds: 3600

    create_search_index_job:
      name: "[${bundle.target}] Create/Update Search Index"
      environments:
        - environment_key: utility_env
          spec:
            environment_version: "2"
            dependencies:
              - azure-search-documents>=11.4.0
      tasks:
        - task_key: create_index
          environment_key: utility_env
          notebook_task:
            notebook_path: ./notebooks/00_create_search_index.py
            source: WORKSPACE
          timeout_seconds: 300

targets:
  dev:
    mode: development
    default: true
  staging:
    mode: development
  prod:
    mode: production
